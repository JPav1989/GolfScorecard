@page "/play"
@using CrazyGolf.UI.Services
@using CrazyGolf.UI.Models
@using MudBlazor
@inject IGameState GameState
@inject NavigationManager NavManager
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-4">
    @if (GameState.CurrentGame == null)
    {
        <MudAlert Severity="Severity.Info">No active game. Please start a new one.</MudAlert>
        <MudButton Link="/setup" Variant="Variant.Filled" Color="Color.Primary">Go to Setup</MudButton>
    }
    else
    {
        <div class="d-flex align-center justify-space-between mb-4">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIos" 
                           Disabled="@(_currentHoleIndex == 0)" 
                           OnClick="PreviousHole" />
            
            <MudText Typo="Typo.h5">Hole @(_currentHoleIndex + 1) of @GameState.CurrentGame.HoleCount</MudText>
            
            <MudIconButton Icon="@Icons.Material.Filled.ArrowForwardIos" 
                           Disabled="@(_currentHoleIndex == GameState.CurrentGame.HoleCount - 1)" 
                           OnClick="NextHole" />
        </div>

        @foreach (var player in GameState.CurrentGame.Players)
        {
            <MudPaper Class="pa-4 mb-3 d-flex align-center justify-space-between" Elevation="2">
                <div>
                    <MudText Typo="Typo.h6">@player.Name</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Total: @player.TotalScore</MudText>
                </div>

                <div class="d-flex align-center">
                    <MudIconButton Icon="@Icons.Material.Filled.RemoveCircleOutline" 
                                   Color="Color.Error" Size="Size.Large"
                                   OnClick="@(() => AdjustScore(player, -1))" />
                    
                    <MudText Typo="Typo.h4" Class="mx-4" Style="min-width: 30px; text-align: center;">
                        @player.HoleScores[_currentHoleIndex]
                    </MudText>

                    <MudIconButton Icon="@Icons.Material.Filled.AddCircleOutline" 
                                   Color="Color.Success" Size="Size.Large"
                                   OnClick="@(() => AdjustScore(player, 1))" />
                </div>
            </MudPaper>
        }

        <div class="mt-6">
            @if (_currentHoleIndex == GameState.CurrentGame.HoleCount - 1)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large"
                           OnClick="FinishGame" EndIcon="@Icons.Material.Filled.EmojiEvents">
                    Finish Game & View Results
                </MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" 
                           OnClick="NextHole">Next Hole</MudButton>
            }
        </div>
    }
</MudContainer>

@code {
    private int _currentHoleIndex = 0;

    protected override void OnInitialized()
    {
        GameState.OnChange += StateHasChanged;
    }

    private void AdjustScore(Player player, int change)
    {
        var currentScore = player.HoleScores[_currentHoleIndex];
        GameState.UpdateScore(player.Name, _currentHoleIndex, currentScore + change);
    }

    private void NextHole() => _currentHoleIndex++;
    private void PreviousHole() => _currentHoleIndex--;

    private async Task FinishGame()
    {
        await GameState.FinishGameAsync();
        NavManager.NavigateTo("/results");
    }

    public void Dispose()
    {
        GameState.OnChange -= StateHasChanged;
    }
}