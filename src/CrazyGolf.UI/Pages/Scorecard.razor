@page "/play"
@using CrazyGolf.UI.Services
@using CrazyGolf.UI.Models
@using MudBlazor
@inject IGameState GameState
@inject NavigationManager NavManager
@implements IDisposable

<style>
    /* Reuse the core neon background */
    .neon-wrapper {
        background: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #09050f 100%);
        min-height: 100vh;
        padding-top: 24px;
        position: relative;
        color: white;
    }

    /* Player Scoring Card */
    .player-card {
        background: rgba(15, 5, 25, 0.85) !important;
        border: 1px solid rgba(0, 242, 255, 0.3) !important;
        border-left: 5px solid #ff00f7 !important; /* Pink accent bar */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        color: white !important;
        transition: transform 0.2s;
    }

    /* The glowing hole score */
    .score-display {
        font-family: 'Courier New', Courier, monospace; /* Digital look */
        color: #39ff14;
        text-shadow: 0 0 10px rgba(57, 255, 20, 0.8);
        font-weight: 900;
    }

    .neon-text-cyan {
        color: #00f2ff;
        text-shadow: 0 0 8px rgba(0, 242, 255, 0.5);
    }

    .neon-text-pink {
        color: #ff00f7;
        text-shadow: 0 0 8px rgba(255, 0, 247, 0.5);
    }

    /* Navigation Icons */
    .nav-icon {
        color: #00f2ff !important;
    }

        .nav-icon.mud-button-disabled {
            opacity: 0.2;
        }

    /* Buttons */
    .btn-finish {
        background: linear-gradient(45deg, #ff00f7, #7000ff) !important;
        box-shadow: 0 0 20px rgba(255, 0, 247, 0.4) !important;
        color: white !important;
    }

    .btn-next {
        border: 1px solid #00f2ff !important;
        color: #00f2ff !important;
    }
</style>

<div class="neon-wrapper">
    <MudContainer MaxWidth="MaxWidth.Small">
        @if (GameState.CurrentGame == null)
        {
            <MudPaper Class="pa-6 neon-card mt-10">
                <MudText Typo="Typo.h6" Class="neon-text-cyan mb-4">No active game detected.</MudText>
                <MudButton Link="/setup" Variant="Variant.Filled" Class="btn-finish" FullWidth="true">
                    Return to Mission Control
                </MudButton>
            </MudPaper>
        }
        else
        {
            @* Header Navigation *@
            <div class="d-flex align-center justify-space-between mb-6">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIos"
                               Class="nav-icon"
                               Disabled="@(_currentHoleIndex == 0)"
                               OnClick="PreviousHole" />

                <div class="text-center">
                    <MudText Typo="Typo.h5" Class="neon-text-cyan" Style="font-weight: 800;">
                        HOLE @(_currentHoleIndex + 1)
                    </MudText>
                    <MudText Typo="Typo.caption" Style="color: rgba(0, 242, 255, 0.6); letter-spacing: 2px;">
                        OF @GameState.CurrentGame.HoleCount
                    </MudText>
                </div>

                <MudIconButton Icon="@Icons.Material.Filled.ArrowForwardIos"
                               Class="nav-icon"
                               Disabled="@(_currentHoleIndex == GameState.CurrentGame.HoleCount - 1)"
                               OnClick="NextHole" />
            </div>

            @* Player Cards *@
            @foreach (var player in GameState.CurrentGame.Players)
            {
                <MudPaper Class="pa-4 mb-4 d-flex align-center justify-space-between player-card rounded-lg">
                    <div>
                        <MudText Typo="Typo.h6" Style="color: white; font-weight: 700;">@player.Name</MudText>
                        <MudText Typo="Typo.caption" Class="neon-text-pink">
                            TOTAL: @player.TotalScore
                        </MudText>
                    </div>

                    <div class="d-flex align-center">
                        <MudIconButton Icon="@Icons.Material.Filled.RemoveCircleOutline"
                                       Style="color: #ff4444;" Size="Size.Large"
                                       OnClick="@(() => AdjustScore(player, -1))" />

                        <MudText Typo="Typo.h3" Class="mx-4 score-display">
                            @player.HoleScores[_currentHoleIndex]
                        </MudText>

                        <MudIconButton Icon="@Icons.Material.Filled.AddCircleOutline"
                                       Style="color: #39ff14;" Size="Size.Large"
                                       OnClick="@(() => AdjustScore(player, 1))" />
                    </div>
                </MudPaper>
            }

            @* Footer Action *@
            <div class="mt-8 pb-10">
                @if (_currentHoleIndex == GameState.CurrentGame.HoleCount - 1)
                {
                    <MudButton Variant="Variant.Filled" Class="btn-finish py-4" FullWidth="true" Size="Size.Large"
                               OnClick="FinishGame" EndIcon="@Icons.Material.Filled.EmojiEvents">
                        FINISH GAME
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Outlined" Class="btn-next py-3" FullWidth="true"
                               OnClick="NextHole" EndIcon="@Icons.Material.Filled.NavigateNext">
                        NEXT HOLE
                    </MudButton>
                }
            </div>
        }
    </MudContainer>
</div>

@code {
    private int _currentHoleIndex = 0;

    protected override void OnInitialized()
    {
        GameState.OnChange += StateHasChanged;
    }

    private void AdjustScore(Player player, int change)
    {
        var currentScore = player.HoleScores[_currentHoleIndex];
        GameState.UpdateScore(player.Name, _currentHoleIndex, currentScore + change);
    }

    private void NextHole() => _currentHoleIndex++;
    private void PreviousHole() => _currentHoleIndex--;

    private async Task FinishGame()
    {
        await GameState.FinishGameAsync();
        NavManager.NavigateTo("/results");
    }

    public void Dispose()
    {
        GameState.OnChange -= StateHasChanged;
    }
}