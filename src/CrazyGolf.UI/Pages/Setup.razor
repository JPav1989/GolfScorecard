@page "/setup"
@using CrazyGolf.UI.Services
@using CrazyGolf.UI.Models
@using MudBlazor
@inject IGameState GameState
@inject NavigationManager NavManager

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">New Game</MudText>
    
    <MudPaper Class="pa-6">
        @if (_step == 1)
        {
            <MudText Typo="Typo.h6" Class="mb-4">Game Settings</MudText>
            
            <MudNumericField @bind-Value="_holeCount" Label="Number of Holes" 
                             Variant="Variant.Outlined" Min="1" Max="18" Class="mb-4" />
            
            <MudNumericField @bind-Value="_playerCount" Label="Number of Players" 
                             Variant="Variant.Outlined" Min="1" Max="6" Class="mb-6" />

            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                       OnClick="NextStep">Next: Player Names</MudButton>
        }
        else
        {
            <MudText Typo="Typo.h6" Class="mb-4">Who is playing?</MudText>

            @for (int i = 0; i < _playerCount; i++)
            {
                int index = i; // Local copy for the binding
                <MudTextField @bind-Value="_playerNames[index]" Label="@($"Player {index + 1} Name")" 
                              Variant="Variant.Outlined" Class="mb-3" Required="true" />
            }

            <div class="d-flex gap-4 mt-6">
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true"
                           OnClick="() => _step = 1">Back</MudButton>
                
                <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true"
                           OnClick="StartGame">Tee Off!</MudButton>
            </div>
        }
    </MudPaper>
</MudContainer>

@code {
    private int _step = 1;
    private int _holeCount = 9;
    private int _playerCount = 2;
    private List<string> _playerNames = new();

    private void NextStep()
    {
        // Initialize or adjust the names list based on player count
        if (_playerNames.Count < _playerCount)
        {
            for (int i = _playerNames.Count; i < _playerCount; i++)
                _playerNames.Add($"Player {i + 1}");
        }
        else if (_playerNames.Count > _playerCount)
        {
            _playerNames = _playerNames.Take(_playerCount).ToList();
        }

        _step = 2;
    }

    private async Task StartGame()
    {
        // 1. Tell the brain to create the game
        await GameState.InitializeGameAsync(_holeCount, _playerNames);

        // 2. Head over to the scorecard!
        NavManager.NavigateTo("/play");
    }
}